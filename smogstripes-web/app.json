[{"name":"app.R","content":"# Install and load required packages\r\nif (!require(\"shiny\")) install.packages(\"shiny\")\r\nif (!require(\"plotly\")) install.packages(\"plotly\")\r\n\r\nlibrary(shiny)\r\nlibrary(plotly)\r\nlibrary(tidyr)\r\nlibrary(broom)\r\nlibrary(ggtext)\r\n\r\ndf_plot_1 <- read_csv('Data/data_w_aqg.csv') %>% \r\n  pivot_longer(cols = c('who_2021', 'who_2005'), names_to = 'who_year', values_to = 'who_val')%>%\r\n  mutate(who_year = str_replace(who_year, 'who_', ''))\r\n\r\ndf_plot_2 <- df_plot_1 %>%\r\n  group_by(uesi_id) %>% mutate(year= year-min(year))%>%\r\n  do(tidy(lm(pm25_mean~ year, data= .)))%>%\r\n  ungroup()%>% filter(term == 'year')\r\n\r\ndf_plot_long <- df_plot_1 %>% left_join(df_plot_2, by = c('uesi_id'))%>%\r\n  mutate(who_val = factor(who_val,\r\n                             levels = c (\"Within Recommended Value of 5µg/m^3\",\r\n                                    \"Within Recommended Value of 10µg/m^3\",\r\n                                    \"Within WHO Interim Target 4 of 10µg/m^3\",\r\n                                    \"Within WHO Interim Target 3 of 15µg/m^3\",\r\n                                    \"Within WHO Interim Target 2 of 25µg/m^3\",\r\n                                    \"Within WHO Interim Target 1 of 35µg/m^3\",\r\n                                    \"Exceeding All Recommended Guidelines & Targets\")))%>%\r\n  mutate(trend = case_when(estimate > 0 & p.value < 0.05 ~ paste0(city, \"(<span style='color: red;'>&#x25B2;<\/span>)\"),\r\n                           estimate < 0 & p.value < 0.05 ~ paste0(city, \"(<span style='color: green;'>&#x25BC;<\/span>)\"),\r\n                           p.value > 0.05 ~ paste0(city, \"(<span style='color: orange;'>&#x25C0;&#x25B6;<\/span>)\")))\r\n\r\n\r\nwho_palette_2021 <- c(\"Within Recommended Value of 5µg/m^3\"= \"#00E400\", \r\n                      \"Within WHO Interim Target 4 of 10µg/m^3\" = \"#FB6A4A\", \r\n                      \"Within WHO Interim Target 3 of 15µg/m^3\"=\"#EF3B2C\", \r\n                      \"Within WHO Interim Target 2 of 25µg/m^3\" = \"#CB181D\", \r\n                      \"Within WHO Interim Target 1 of 35µg/m^3\" = \"#A50F15\", \r\n                      \"Exceeding All Recommended Guidelines & Targets\" = \"#67000D\")\r\nwho_palette_2005 <- c(\"Within Recommended Value of 10µg/m^3\" = \"#00E400\",            \r\n                      \"Within WHO Interim Target 3 of 15µg/m^3\" = \"#EF3B2C\", \r\n                      \"Within WHO Interim Target 2 of 25µg/m^3\" = \"#CB181D\", \r\n                      \"Within WHO Interim Target 1 of 35µg/m^3\" = \"#A50F15\", \r\n                      \"Exceeding All Recommended Guidelines & Targets\" =\"#67000D\")\r\n\r\n\r\n# UI\r\nui <- page_navbar(\r\n  selected = \"Smogstripes\",\r\n  collapsible = TRUE,\r\n  theme = bslib::bs_theme(),\r\n  nav_panel(\r\n    title = \"Smogstripes\",\r\n    grid_container(\r\n      layout = c(\r\n        \"area0\"\r\n      ),\r\n      row_sizes = c(\r\n        \"1fr\"\r\n      ),\r\n      col_sizes = c(\r\n        \"1fr\"\r\n      ),\r\n      gap_size = \"10px\",\r\n      grid_card(\r\n        area = \"area0\",\r\n        card_body(plotlyOutput(outputId = \"main_plot\"))\r\n      )\r\n    )\r\n  ),\r\n  nav_panel(\r\n    title = \"Parameters\",\r\n    grid_container(\r\n      layout = c(\r\n        \"facetOption\",\r\n        \"facetOption\"\r\n      ),\r\n      row_sizes = c(\r\n        \"370px\",\r\n        \"1fr\"\r\n      ),\r\n      col_sizes = c(\r\n        \"1fr\"\r\n      ),\r\n      gap_size = \"10px\",\r\n      grid_card(\r\n        area = \"facetOption\",\r\n        card_header(\"Selection for visualization\"),\r\n        card_body(\r\n          radioButtons(\r\n            \"who_select\", \"Select WHO Standard:\", choices = unique(df_plot_long$who_year), selected = unique(df_plot_long$who_year)[1],\r\n            width = \"100%\"\r\n          ),\r\n          selectizeInput(\"cities_select\", \"Select Cities:\", choices = unique(df_plot_long$city), \r\n                         multiple = TRUE,\r\n                         options = list(maxItems = 12),\r\n                         selected = df_plot_long$city %>% unique() %>% sample(12))\r\n        )\r\n      )\r\n    )\r\n  )\r\n)\r\n\r\n\r\n# Server\r\nserver <- function(input, output) {\r\n  output$main_plot <- renderPlotly({\r\n    filtered_data <- df_plot_long[df_plot_long$city %in% input$cities_select & df_plot_long$who_year == input$who_select, ]\r\n    \r\n    # Your ggplot code\r\n    aq_stripe <- ggplot(filtered_data,\r\n                        aes(x = year, y = 1, fill = who_val))+ \r\n      geom_tile() +\r\n      scale_y_continuous(expand = c(0, 0)) +\r\n      scale_fill_manual(values = get(paste0('who_palette_', unique(filtered_data$who_year)))) +\r\n      guides(fill = guide_colorbar(barwidth = 1))+\r\n      guides(fill = guide_legend(title = paste0(\"WHO Guidelines (\", unique(filtered_data$who_year),\")\"))) +\r\n      labs(title = paste0(\"1998-2022 AIR QUALITY BY WHO GUIDELINES (\", unique(filtered_data$who_year),\")\"))+\r\n      theme_minimal() +\r\n      theme(axis.text.y = element_blank(),\r\n            axis.line.y = element_blank(),\r\n            axis.title = element_blank(),\r\n            panel.grid.major = element_blank(),\r\n            legend.title = element_blank(),\r\n            legend.position = 'top',\r\n            legend.box = \"horizontal\",\r\n            #axis.text.x = element_text(vjust = 3),\r\n            axis.text.x = element_blank(),\r\n            # axis.text.x = element_text(angle=90),\r\n            panel.grid.minor = element_blank(),\r\n            plot.title = element_text(size = 14, face = \"bold\"),\r\n            plot.subtitle = element_textbox_simple(size = 10),\r\n            plot.margin = margin(1, 0, 0, 0, \"cm\"),\r\n            strip.text = ggtext::element_markdown(),\r\n            strip.text.x = element_text(size=11, face=\"bold\")\r\n      )+# Adjust theme as needed\r\n      facet_wrap(~trend)\r\n    \r\n    # Convert ggplot object to plotly\r\n    p <- ggplotly(aq_stripe, tooltip= \"all\")\r\n      # layout(title = list(text = paste0(\"1998-2022 AIR QUALITY BY WHO GUIDELINES (\", unique(filtered_data$who_year),\")\") ,\r\n      #                     x = 0, y = 1,\r\n      #                     pad = list(b = 60, l = 0, r = 0 )))\r\n    \r\n    p\r\n  })\r\n}\r\n\r\n# Run the app\r\nshinyApp(ui, server)\r\n","type":"text"}]
